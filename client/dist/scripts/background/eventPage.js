var r=/:\/\/(.[^/]+)/,prevWebsite='',myURL='about:blank',msgs='';console.log('start');var creds,newsKeys,URL=chrome.extension.getURL('../../common/news_websites.json'),request=new XMLHttpRequest;if(request.open('GET',URL,!1),request.send(null),200===request.status)msgs=JSON.parse(request.responseText);chrome.storage.sync.get('diiKeys',function(e){console.log('Old Keys:'),console.log(e),creds=e.diiKeys;}),chrome.storage.sync.get('newsKeys',function(e){console.log('Old Keys:'),console.log(e),newsKeys=e.newsKeys;});var websites=msgs.Website,domainsList=msgs.Domain,comments=msgs.Comments,newsOriginContextMenu={id:'SsSorigin',title:'Get probable News ',contexts:['selection']},diiContextMenu={id:'diiMenu',title:'Check image for disinformation',contexts:['image']},fnContextMenu={id:'fnMenu',title:'Check for Fake News',contexts:['selection','link']},ReportFnMenu={id:'reportFNMenu',title:'Report For Fake News',contexts:['link','selection']},ReportHsMenu={id:'reportHSMenu',title:'Report For Hate Speech',contexts:['link','selection']};chrome.contextMenus.create(ReportFnMenu),chrome.contextMenus.create(ReportHsMenu);var CheckShcMenu={id:'CheckShcMenu',title:'Check Url Safety',contexts:['link','selection']},CheckSslMenu={id:'CheckSslMenu',title:'Check SSL Validity',contexts:['link','selection']};chrome.contextMenus.create(CheckShcMenu),chrome.contextMenus.create(CheckSslMenu);var factCheckerContextMenu={id:'fcMenu',title:'Check for Fact Checker',contexts:['link','selection']};function dii(e){console.log(e.srcURL);}function saveToLocalAndDB(e,t){if('reportFNMenu'===e)if((o=new XMLHttpRequest).onreadystatechange=function(){if(4===this.readyState&&200===this.status){var e=JSON.parse(o.responseText);chrome.storage.sync.get('reported_contents',function(t){0===Object.keys(t).length&&(t={reported_contents:{reported_fake_news:{},reported_hate_speech:{}}}),t.reported_contents.reported_fake_news[e.text]=null,chrome.storage.sync.set(t,function(){console.log(t);});});chrome.notifications.create({type:'basic',title:'Reported Successfully ',message:'Thanks for your feedback!! ',iconUrl:'../../assets/icon/72.png'});}},t.selectionText)chrome.storage.sync.get('reported_contents',function(e){void 0===e.reported_contents.reported_fake_news[t.selectionText]&&(o.open('GET','https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/reportfake?text='+t.selectionText,!0),o.send());});else{var s=JSON.stringify({link:t.linkUrl});o.open('POST','https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/reportfake',!0),o.setRequestHeader('Content-type','application/json'),o.send(s);}else if('reportHSMenu'===e){var o;if((o=new XMLHttpRequest).onreadystatechange=function(){if(4===this.readyState&&200===this.status){var e=JSON.parse(o.responseText);chrome.storage.sync.get('reported_contents',function(t){0===Object.keys(t).length&&(t={reported_contents:{reported_fake_news:{},reported_hate_speech:{}}}),t.reported_contents.reported_hate_speech[e.text]=null,chrome.storage.sync.set(t,function(){console.log(t);});});chrome.notifications.create({type:'basic',title:'Reported Successfully ',message:'Thanks for your feedback!! ',iconUrl:'../../assets/icon/72.png'});}},t.selectionText)chrome.storage.sync.get('reported_contents',function(e){void 0===e.reported_contents.reported_hate_speech[t.selectionText]&&(o.open('GET','https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/reporthate?text='+t.selectionText,!0),o.send());});else{s=JSON.stringify({link:t.linkUrl});o.open('POST','https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/reporthate',!0),o.setRequestHeader('Content-type','application/json'),o.send(s);}}}function getSearchKeywords(e){const t=new Set;t.add(e);let s=nlp(e).sentences().data();for(let e=0;e<s.length;e++){let o=s[e].text;t.add(o);let n=nlp(o),c=n.nouns().text(),r=n.adjectives().text(),a=n.verbs().text(),i=c;r&&(i+=' OR '+c+' '+r),a&&(i+=' OR '+c+' '+a),t.add(i);}return t;}function getQueryResults(e){let t=new DOMParser,s=[];return e.forEach(e=>{s.push(fetch('https://news.google.com/rss/search?q='+e+'&hl=en-IN&gl=IN&ceid=IN:en').then(e=>e.text()).then(e=>t.parseFromString(e,'text/xml')).then(e=>{let t=e.querySelectorAll('title'),s=[];for(let e=1;e<t.length;e++)s.push(t[e].textContent);return s;}));}),Promise.all(s).then(e=>{let t=[];for(let s=0;s<e.length;s++)t=t.concat(e[s]);return new Set(t);});}function getFactCheck(e){var t={method:'GET',redirect:'follow'};chrome.storage.sync.get('newsKeys',function(s){creds=s.newsKeys,fetch('https://factchecktools.googleapis.com/v1alpha1/claims:search?query='+e+'&key='+creds,t).then(e=>e.text()).then(s=(t=>{if(JSON.parse(t).claims){fetch('https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/savefc',{method:'POST',headers:{'Content-Type':'application/json'},body:t}).then(e=>{console.log('Saved Successfully');}).catch(error=(e=>{console.log('error',e);}));}chrome.windows.create({url:'scripts/content/dii/fcResult.html?api=fc&src='+btoa(unescape(encodeURIComponent(t)))+'&searchText='+btoa(unescape(encodeURIComponent(e))),focused:!0,type:'popup'});})).catch(error=(e=>{console.log('error',e);}));});}function checkFakeNews(e){getQueryResults(getSearchKeywords(e)).then(t=>{var s=new Headers;s.append('Content-Type','application/json');var o=JSON.stringify({query:e,relatedArticles:Array.from(t)});fetch('https://e9jbajkrq6.execute-api.us-east-2.amazonaws.com/dev/predict',{method:'POST',headers:s,body:o,redirect:'follow'}).then(e=>e.text()).then(result=(t=>{console.log('result'+t),chrome.windows.create({url:'scripts/content/dii/fnResult.html?api=fn&src='+btoa(unescape(encodeURIComponent(e)))+'&result='+btoa(unescape(encodeURIComponent(t))),focused:!0,type:'popup'});})).catch(e=>alert('error',e));});}function checkWebsite(e){if(prevWebsite!==e){console.log('visiting: '+e);for(var t=0;t<1964;t++)if(e===domainsList[t]||e.includes(domainsList[t])||domainsList[t].includes(e)){var s={type:'basic',title:'Webite Info: '+websites[t],message:'Comments: '+comments[t],iconUrl:'../../assets/icon/72.png'};chrome.notifications.create(s);break;}}prevWebsite=e;}chrome.contextMenus.create(newsOriginContextMenu),chrome.contextMenus.create(diiContextMenu),chrome.contextMenus.create(fnContextMenu),chrome.contextMenus.create(factCheckerContextMenu),chrome.contextMenus.onClicked.addListener(function(e){if('SsSorigin'===e.menuItemId&&e.selectionText){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(4===this.readyState&&200===this.status){var e=JSON.parse(t.responseText),s=e.HIGH,o={type:'basic',title:'Origin probabilities: ',message:'High:'+s+', SOME: '+e.SOME,expandedMessage:'High'+e.MINIMAL,iconUrl:'../../assets/icon/72.png'};console.log(s),chrome.notifications.create(o);}},chrome.storage.sync.get('newsKeys',function(e){console.log('Old Keys:'),console.log(e),newsKeys=e.newsKeys;}),t.open('GET','https://phcg4hgf84.execute-api.us-east-1.amazonaws.com/dev/pred?text='+e.selectionText+'&key='+newsKeys,!0),t.send();}if('diiMenu'===e.menuItemId){var s=e.srcUrl;console.log(e.srcUrl);new URLSearchParams;var o={method:'GET',redirect:'follow'};console.log(creds),chrome.storage.sync.get('diiKeys',function(e){console.log('Old Keys:'),console.log(e),creds=e.diiKeys;}),fetch('https://j9sgfnzwo8.execute-api.us-east-1.amazonaws.com/dev/lookup/?creds='+creds+'&link='+s,o).then(e=>e.text()).then(result=(e=>{console.log('result'+e),chrome.windows.create({url:'scripts/content/dii/diiResult.html?api=dii&imgsrc='+btoa(s)+'&result='+btoa(e),focused:!0,type:'popup'});})).catch(error=(e=>{console.log('error',e);}));}if('CheckShcMenu'===e.menuItemId){console.log(e);let t=e.linkUrl;console.log(typeof t);o={method:'GET'};fetch('http://127.0.0.1:5000/shc?url='+t,o).then(e=>e.json()).then(result=(e=>{console.log(e),chrome.windows.create({url:'scripts/content/shc/shcResult.html?api=shc&score='+btoa(e[Object.keys(e)[0]])+'&valid='+btoa(e[Object.keys(e)[1]])+'&target='+btoa(e[Object.keys(e)[2]]),focused:!0,type:'popup'});})).catch(error=(e=>{console.log('error',e);}));}if('CheckSslMenu'===e.menuItemId){console.log(e);let t=e.linkUrl;console.log(t);o={method:'GET'};fetch('http://127.0.0.1:5000/ssl?url='+t,o).then(e=>e.json()).then(result=(e=>{console.log(e),chrome.windows.create({url:'scripts/content/shc/shcResult.html?api=ssl&safe='+btoa(e[Object.keys(e)[0]])+'&valid='+btoa(e[Object.keys(e)[1]])+'&target='+btoa(e[Object.keys(e)[2]]),focused:!0,type:'popup'});})).catch(error=(e=>{console.log('error',e);}));}if('fnMenu'===e.menuItemId){let t='';if(e.selectionText)checkFakeNews(t=e.selectionText);else{let s=JSON.stringify({link:e.linkUrl});fetch('https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/getText',{method:'POST',headers:{'Content-Type':'application/json'},body:s}).then(e=>e.json()).then(e=>{checkFakeNews(t=e.searchText);});}}if('reportFNMenu'!==e.menuItemId&&'reportHSMenu'!==e.menuItemId||saveToLocalAndDB(e.menuItemId,e),'fcMenu'===e.menuItemId){let t='';if(e.selectionText)getFactCheck(t=e.selectionText);else{let s=JSON.stringify({link:e.linkUrl});fetch('https://se7c1fy10c.execute-api.us-east-2.amazonaws.com/dev/getText',{method:'POST',headers:{'Content-Type':'application/json'},body:s}).then(e=>e.json()).then(e=>{getFactCheck(t=e.searchText);});}}}),chrome.tabs.onUpdated.addListener(function(e,t,s){chrome.tabs.getSelected(null,function(e){myURL=e.url,k=myURL,k=myURL.match(r)[1],myWebsite=k.replace(/^(https?:\/\/)?(www\.)?/,''),checkWebsite(myWebsite),chrome.storage.sync.set({website:myWebsite});});});